<!DOCTYPE html>
<html lang="he" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>טופס הזמנה</title>
        <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap-rtl.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js"></script> -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css"
              rel="stylesheet">
        <!-- Bootstrap RTL CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap-rtl.min.css"
              rel="stylesheet">
        <!-- jQuery -->
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"
                crossorigin="anonymous"></script>
        <!-- jQuery UI -->
        <link rel="stylesheet"
              href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">
        <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.js"></script>
        <!-- Bootstrap JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
                crossorigin="anonymous"></script>
        <style>
            * {
                text-align: right;
            }

            body {
                font-family: Arial, sans-serif;
                background-color: #ECF0F1;
                color: #2C3E50;
            }

            .container {
                background: white;
                padding: 20px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                margin-top: 20px;
                border-radius: 8px;
            }

            header {
                text-align: center;
                margin-bottom: 20px;
                color: #2C3E50;
            }

            .form-section {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-between;
                margin-bottom: 20px;
            }

            .form-section div {
                width: 100%;
                margin-bottom: 10px;
            }

            @media (min-width: 768px) {
                .form-section div {
                    width: 48%;
                }
            }

            .form-check-inline {
                margin-left: 10px;
                display: flex;
                align-items: center;
            }

            .form-check-inline input {
                margin-right: 5px;
            }

            table,
            th,
            td {
                text-align: center;
                padding: 8px;
                border: 1px solid #2C3E50;
            }

            table input {
                width: 100%;
                border: none;
                text-align: center;
            }

            .logo {
                margin-top: 20px;
                text-align: center;
            }

            .logo img {
                max-width: 100%;
                height: auto;
            }

            .text-danger {
                margin-top: 10px;
                margin-bottom: 10px;
                color: #E74C3C;
            }

            input[type="text"] {
                width: 100%;
                border: none;
                border-bottom: 1px solid #2C3E50;
                text-align: center;
                min-width: 37px;
            }

            .btn-primary {
                background-color: #3498DB;
                border-color: #3498DB;
            }

            .btn-primary:hover {
                background-color: #2980B9;
                border-color: #2980B9;
            }

            .btn-secondary {
                background-color: #95A5A6;
                border-color: #95A5A6;
            }

            .btn-secondary:hover {
                background-color: #7F8C8D;
                border-color: #7F8C8D;
            }

            p,
            label {
                color: #2C3E50;
            }

            input[type="checkbox"]:checked {
                background-color: #3498DB;
                border-color: #3498DB;
            }

            textarea {
                border: 1px solid #2C3E50;
            }

            .disclaymer {
                background-color: #fcf7f7;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                padding: 10px;
                border-radius: 5px;
                margin-bottom: 20px;
            }

            .sum-col {
                background-color: #f5f5f5;
                position: sticky;
                left: 0;
                z-index: 2;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>טופס הזמנה</h1>
            </header>
            <form id="orderForm"  enctype="multipart/form-data">
                <div class="form-section">
                    <div>
                        <p>
                            שם לקוח:
                            <input type="text" id="customerName">
                        </p>
                        <p>
                            נייד:
                            <input type="text" id="phoneNumber">
                        </p>
                        <!-- <p>לביצוע ע"י: <input type="text" id="byWho"></p> -->
                        <p>
                            סוג הדפסה:
                            <input type="text" id="printType">
                        </p>
                        <p>
                            צבע הדפסה:
                            <input type="text" id="printColor">
                        </p>
                    </div>
                    <!-- <div>
                    <p>תאריך: <input type="text" id="date" disabled></p>
                    <p>גודל הדפסה: <input type="text" id="printSize" disabled></p>
                    <p>מבצע הזמנה: <input type="text" id="orderExecutor" disabled></p>
                    <p>הורדה ובדיקת מסמכים: <input type="text" id="documentsCheck" disabled></p>
                    <p>בדיקת סיום עבודה: <input type="text" id="workCompletionCheck" disabled></p>
                </div> -->
                </div>
                <!-- <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="laserEmbroidery" disabled>
                <label class="form-check-label" for="laserEmbroidery">רקמה לייזר</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="uv" disabled>
                <label class="form-check-label" for="uv">UV</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="tiff" disabled>
                <label class="form-check-label" for="tiff">TIFF</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="digital" disabled>
                <label class="form-check-label" for="digital">דיגיטלי</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="silk" disabled>
                <label class="form-check-label" for="silk">משי</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="sticker" disabled>
                <label class="form-check-label" for="sticker">מדבקה</label>
            </div> -->
                <div class="form-group">
                    <label for="fileUpload">העלאת קבצים</label>
                    <input type="file"
                           class="form-control"
                           id="fileUpload"
                           name="files[]"
                           multiple
                           onchange="newFilesUpload(event)">
                </div>
                <div class="form-group">
                    <table>
                        <thead>
                            <tr>
                                <th>שם קובץ</th>
                                <th>הערות</th>
                            </tr>
                        </thead>
                        <tbody id="files-comments-tbody">
                        </tbody>
                    </table>
                </div>
                <p class="text-danger">* אין לעבוד ללא הזמנה והדמיה!</p>
                <div class="table-responsive">
                    <table class="table table-bordered" style="direction: rtl;">
                        <thead>
                            <tr>
                                <th>שם מוצר</th>
                                <th>צבע</th>
                                <th>3XL</th>
                                <th>XXL</th>
                                <th>XL</th>
                                <th>L</th>
                                <th>M</th>
                                <th>S</th>
                                <th>18</th>
                                <th>16</th>
                                <th>14</th>
                                <th>12</th>
                                <th>10</th>
                                <th>8</th>
                                <th>6</th>
                                <th>4</th>
                                <th>2</th>
                                <th class="sum-col">כמות</th>
                            </tr>
                        </thead>
                        <tbody id="products-table">
                            <!-- spinner -->
                            <tr>
                                <td colspan="18">
                                    <div class="spinner-border" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="18">
                                    <button type="button"
                                            class="btn btn-primary"
                                            onclick="craeteEmptyRow(++products_table_size)">הוסף שורה</button>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="form-group">
                    <label for="additionalNotes">הערות נוספות להזמנה</label>
                    <textarea class="form-control" id="additionalNotes" rows="3"></textarea>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="fullPartialPayment">
                    <label class="form-check-label" for="fullPartialPayment">תשלום מלא/חלקי בסכום</label>
                    <input type="text"
                           id="paymentAmount"
                           style="width: 100px;
                                  border: none;
                                  border-bottom: 1px solid #2C3E50;
                                  text-align: center">
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="delivery">
                    <label class="form-check-label" for="delivery">משלוח</label>
                    <input type="text"
                           id="deliveryAddress"
                           style="width: 100px;
                                  border: none;
                                  border-bottom: 1px solid #2C3E50;
                                  text-align: center">
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="story">
                    <label class="form-check-label" for="story">סטורי</label>
                </div>
                <p id="validate-error-message" class="text-danger"></p>
                <div class="disclaymer">
                    <b>
                        שים לב!
                        <br>
                    </b>
                    לאחר אישור הגהה וגרפיקה לא ניתן לשנות, כל שינוי נוסף או אחר יהיה על חשבון הלקוח.
                    <br>
                    ההדפסות במפעל הן בעבודת יד אומנותיות לכן עלולה להיות סטייה.
                </div>
                <button type="button"
                        class="btn btn-primary"
                        onclick="saveData()"
                        id="submit-btn">שלח הזמנה</button>
                <!-- <button type="button" class="btn btn-secondary" onclick="loadData()">טען נתונים</button> -->
            </form>
            <footer class="logo text-center mt-4" style="margin-bottom: 350px">
                <a href="https://mymoment.co.il/">
                    <img src="https://mymoment.co.il/wp-content/uploads/2020/09/Asset-1@2x.png"
                         alt="MYmoment">
                </a>
                <p>שלושת בני עין חרוד, באר שבע</p>
            </footer>
        </div>
        <script>
            let products_table_size = 0;
            let products_table_tbody = document.getElementById('products-table');
            let products_list = undefined;
            const APPSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyZQq5T-A3R0ZQNxyiLBji6fPS1kTah1Nfsc0X2ww_gGs44gyKsSGX405Xa2e9xUTbVrw/exec';
            let uploaded_files = [];

            init_radio_buttons_auto_focus();


            function init_radio_buttons_auto_focus() {
                let fullPartialPayment = document.getElementById('fullPartialPayment');
                fullPartialPayment.addEventListener('change', () => {
                    if (fullPartialPayment.checked) {
                        document.getElementById('paymentAmount').focus();
                    } else {
                        // document.getElementById('paymentAmount').value = '';
                    }
                });

                let delivery = document.getElementById('delivery');
                delivery.addEventListener('change', () => {
                    if (delivery.checked) {
                        document.getElementById('deliveryAddress').focus();
                    } else {
                        // document.getElementById('deliveryAddress').value = '';
                    }
                });

            }
            // when the document is loaded, we add 10 new rows to the table
            // document.addEventListener('DOMContentLoaded', () => {


            // },false);
            function removeFile(event, filename) {
                uploaded_files = uploaded_files.filter(file => file.name != filename);
                event.target.parentElement.parentElement.parentElement.remove();
                // uploaded_files.splice(index-1, 1);
                // event.target.parentElement.parentElement.parentElement.remove();
            }

            function newFilesUpload(event) {
                debugger;
                console.log(event.target.files);
                // let filesComments = document.getElementById('filesComments');
                // filesComments.innerHTML = '';
                // // for each file, show each name and input for comments
                // for (let i = 0; i < event.target.files.length; i++) {
                //     let file = event.target.files[i];
                //     let fileComment = document.createElement('div');
                //     fileComment.innerHTML = `
                //         <p>${file.name}
                //         <input type="text" placeholder="הערות לקובץ (איפה להדפיס)" style="width: 100%; border: none; border-bottom: 1px solid #2C3E50; text-align: center;"></p>
                //     `;
                //     filesComments.appendChild(fileComment);
                // }

                let filesComments = document.getElementById('files-comments-tbody');
                for (let i = 0; i < event.target.files.length; i++) {
                    uploaded_files.push({
                        'file': event.target.files[i],
                        'name': event.target.files[i].name
                    });
                    let tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td><div d-flex>
                        <button type="button" class="btn btn-danger" onclick="removeFile(event, '${uploaded_files[uploaded_files.length - 1]['name']}')">הסר</button>
                        ${event.target.files[i].name}
                    </div>
                        </td>
                    <td><input type="text" placeholder="הערות לקובץ (איפה להדפיס)" style="width: 100%; border: none; border-bottom: 1px solid #2C3E50; text-align: center;"></td>
                `;
                    filesComments.appendChild(tr);
                }

            }

            async function fetch_products_list(retry = 0, max_retries = 3) {
                if (retry >= max_retries) {
                    return [];
                } else {
                    try {
                        let response = await fetch(APPSCRIPT_URL);
                        let data = await response.json();
                        return data;
                    } catch (error) {
                        console.error('Error fetching products list:', error);
                        return fetch_products_list(retry + 1);
                    }
                }
                // let response = await fetch(APPSCRIPT_URL);
                // let data = await response.json();
                // return data;
            }

            $(async function() {
                let data = await fetch_products_list();
                let products_names = data.map(product => product['שם מוצר']);
                products_list = products_names;
                // $('#input-datalist').autocomplete({
                // source: availableTags,
                // minLength: 0
                // }).focus(function() {
                //     $(this).autocomplete("search", "");
                // });
                products_table_tbody.innerHTML = '';

                for (let i = 1; i <= 10; i++) {
                    craeteEmptyRow(i);
                    products_table_size = i;
                }
            });


            function craeteEmptyRow(idx) {
                let tr = document.createElement('tr');
                tr.innerHTML = `
                <td><input type="text" id="productName${idx}"></td>
                <td><input type="text" id="color${idx}"></td>
                <td><input type="text" id="size3XL-${idx}"></td>
                <td><input type="text" id="sizeXXL-${idx}"></td>
                <td><input type="text" id="sizeXL-${idx}"></td>
                <td><input type="text" id="sizeL-${idx}"></td>
                <td><input type="text" id="sizeM-${idx}"></td>
                <td><input type="text" id="sizeS-${idx}"></td>
                <td><input type="text" id="size18-${idx}"></td>
                <td><input type="text" id="size16-${idx}"></td>
                <td><input type="text" id="size14-${idx}"></td>
                <td><input type="text" id="size12-${idx}"></td>
                <td><input type="text" id="size10-${idx}"></td>
                <td><input type="text" id="size8-${idx}"></td>
                <td><input type="text" id="size6-${idx}"></td>
                <td><input type="text" id="size4-${idx}"></td>
                <td><input type="text" id="size2-${idx}"></td>
                <td class="sum-col"><input type="text" id="quantity${idx}" disabled></td>
            `;
                // quantity calculation: sum of all sizes
                tr.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', () => {
                        let sum = 0;
                        tr.querySelectorAll('input').forEach(input => {
                            if (input.id.includes('size')) {
                                sum += parseInt(input.value) || 0;
                            }
                        });
                        tr.querySelector(`#quantity${idx}`).value = sum;
                    });
                });

                // add product list to the productName input and open the autocomplete on focus
                let productNameInput = tr.querySelector(`#productName${idx}`);
                productNameInput.addEventListener('focus', () => {
                    productNameInput.value = '';
                    $(productNameInput).autocomplete('search', '');
                });
                $(productNameInput).autocomplete({
                    source: products_list,
                    minLength: 0
                });

                // add the row to the table

                products_table_tbody.appendChild(tr);

            }

            let validate_error_message = document.getElementById('validate-error-message');

            function validateForm() {
                return validateProductNames() &&
                    validateQuantitiesWithoutProductNames();
            }

            function validateQuantitiesWithoutProductNames() {
                for (let i = 1; i <= products_table_size; i++) {
                    let productName = document.getElementById(`productName${i}`).value;
                    let quantity = document.getElementById(`quantity${i}`).value;
                    if (!productName && quantity && quantity != '0') {
                        document.getElementById(`productName${i}`).style.border = '1px solid red';
                        validate_error_message.innerText = 'יש למלא שם מוצר לכל שורה שיש בה כמות';
                        return false;
                    } else {
                        document.getElementById(`productName${i}`).style.border = '';
                    }
                }
                return true;
            }

            function validateProductNames() {
                for (let i = 1; i <= products_table_size; i++) {
                    let element = document.getElementById(`productName${i}`);
                    let productName = element.value;
                    if (productName && !products_list.includes(productName)) {
                        element.style.border = '1px solid red';
                        validate_error_message.innerText = 'שם המוצר לא קיים במערכת';
                        return false;
                    } else {
                        element.style.border = '';
                    }
                }
                return true;
            }


            function saveData() {
                debugger;
                if (!validateForm()) return;
                let submitBtn = document.getElementById('submit-btn');

                submitBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="sr-only"></span></div> שולח... נא להמתין';
                submitBtn.disabled = true;
                const data = [];
                for (let i = 1; i <= products_table_size; i++) {
                    data.push({
                        size2: document.getElementById(`size2-${i}`).value,
                        size4: document.getElementById(`size4-${i}`).value,
                        size6: document.getElementById(`size6-${i}`).value,
                        size8: document.getElementById(`size8-${i}`).value,
                        size10: document.getElementById(`size10-${i}`).value,
                        size12: document.getElementById(`size12-${i}`).value,
                        size14: document.getElementById(`size14-${i}`).value,
                        size16: document.getElementById(`size16-${i}`).value,
                        size18: document.getElementById(`size18-${i}`).value,
                        sizeS: document.getElementById(`sizeS-${i}`).value,
                        sizeM: document.getElementById(`sizeM-${i}`).value,
                        sizeL: document.getElementById(`sizeL-${i}`).value,
                        sizeXL: document.getElementById(`sizeXL-${i}`).value,
                        sizeXXL: document.getElementById(`sizeXXL-${i}`).value,
                        size3XL: document.getElementById(`size3XL-${i}`).value,
                        color: document.getElementById(`color${i}`).value,
                        productName: document.getElementById(`productName${i}`).value
                    });
                }
                const additionalData = {
                    customerName: document.getElementById('customerName').value,
                    phoneNumber: document.getElementById('phoneNumber').value,
                    byWho: '',
                    printType: document.getElementById('printType').value,
                    printColor: document.getElementById('printColor').value,
                    date: new Intl.DateTimeFormat('he-IL', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        // Replace the default dots with slashes
                    }).format(new Date()).replace(/\./g, '/'),
                    printSize: '',
                    orderExecutor: '',
                    documentsCheck: '',
                    workCompletionCheck: '',
                    laserEmbroidery: false,
                    uv: false,
                    tiff: false,
                    digital: false,
                    silk: false,
                    sticker: false,
                    additionalNotes: document.getElementById('additionalNotes').value,
                    fullPartialPayment: document.getElementById('fullPartialPayment').checked,
                    paymentAmount: document.getElementById('paymentAmount').value,
                    delivery: document.getElementById('delivery').checked,
                    deliveryAddress: document.getElementById('deliveryAddress').value,
                    story: document.getElementById('story').checked,
                };
                localStorage.setItem('formData', JSON.stringify({
                    data,
                    additionalData
                }));
                debugger;
                //const fileUpload = document.getElementById('fileUpload');
                const files = uploaded_files.map(file => file.file);
                const files64EncodeArray = [];
                const filePromises = Array.from(files).map(file => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            files64EncodeArray.push({
                                'name': file.name,
                                'data': e.target.result,
                                // 'comment': document.getElementById('filesComments').children[files64EncodeArray.length].querySelector('input').value
                            });
                            resolve();
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                });

                Promise.all(filePromises)
                    .then(() => {
                        // add the comments to the files
                        let filesComments = document.getElementById('files-comments-tbody');
                        for (let i = 0; i < files64EncodeArray.length; i++) {
                            files64EncodeArray[i].comment = filesComments.children[i].querySelector('input').value;
                        }
                        console.log(files64EncodeArray);
                        debugger;
                        saveToGoogleSheets(data, additionalData, files64EncodeArray); // Call the function to save data to Google Sheets
                    })
                    .catch(error => {
                        console.error('Error encoding files:', error);

                        submitBtn.disabled = false;
                    }).finally(() => {});



            }

            function saveToGoogleSheets(data, additionalData, files) {
                console.log(data, additionalData);
                // const url = 'https://script.google.com/macros/s/AKfycbzmhWvaqNeib3REFUEboZo12ohuDKCiN8nT5eGORwV-fWIcJKs2qzVNPflZZLchHwvh/exec';


                fetch(APPSCRIPT_URL, {
                        method: 'POST',
                        //body: formData,
                        mode: 'no-cors',
                        body: JSON.stringify({
                            data,
                            additionalData,
                            files
                        })
                    })
                    .then(response => {
                        console.log('Success:', response);
                        alert('נשמר בהצלחה');
                        document.getElementById('orderForm').reset();
                        uploaded_files = [];
                        document.getElementById('files-comments-tbody').innerHTML = '';

                    })
                    .catch(error => {
                        console.error('Error:', error);
                    }).finally(() => {
                        document.getElementById('submit-btn').disabled = false;
                        document.getElementById('submit-btn').innerText = 'שלח הזמנה';

                    });
            }
        </script>
    </body>
</html>
<!--
 formula: SUM(LIST(NUMBER([3XL]),NUMBER([XXL]),NUMBER([XL]),NUMBER([L]),NUMBER([M]),NUMBER([S]),NUMBER([18]),NUMBER([16]),NUMBER([14]),NUMBER([12]),NUMBER([10]),NUMBER([8]),NUMBER([6]),NUMBER([4]),NUMBER([2]))) 
 formatted formula:
    SUM(
        LIST(
            NUMBER([3XL]),
            NUMBER([XXL]),
            NUMBER([XL]),
            NUMBER([L]),
            NUMBER([M]),
            NUMBER([S]),
            NUMBER([18]),
            NUMBER([16]),
            NUMBER([14]),
            NUMBER([12]),
            NUMBER([10]),
            NUMBER([8]),
            NUMBER([6]),
            NUMBER([4]),
            NUMBER([2])
        )
    )
-->
